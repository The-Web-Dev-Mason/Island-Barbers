<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Barber Admin | Manage Bookings</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        body { background: #111; color: white; padding: 20px; font-family: 'Manrope', sans-serif; }
        .admin-container { max-width: 800px; margin: 0 auto; }
        .booking-card { 
            background: #222; border: 1px solid #333; padding: 15px; margin-bottom: 10px; 
            display: flex; justify-content: space-between; align-items: center;
        }
        .booking-info { flex-grow: 1; }
        .cancel-btn { 
            background: #d9534f; color: white; border: none; padding: 8px 15px; cursor: pointer; 
            font-weight: bold; border-radius: 4px;
        }
        .cancel-btn:hover { background: #c9302c; }
        .login-screen { text-align: center; margin-top: 100px; }
        input { padding: 10px; border-radius: 4px; border: none; }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>

    <div id="login-screen" class="login-screen">
        <h2>Barber Login</h2>
        <input type="password" id="adminPin" placeholder="Enter PIN">
        <button onclick="checkLogin()" class="btn" style="padding: 10px 20px;">Login</button>
    </div>

    <div id="dashboard" class="admin-container" style="display:none;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 20px;">
            <h1>Todays Bookings</h1>
            <button onclick="loadBookings()" class="btn-outline" style="padding:5px 10px;">Refresh</button>
        </div>
        <div id="bookings-list">Loading...</div>
    </div>

    <script>
        // --- CONFIG ---
        const SUPABASE_URL = 'https://afenurhtovmnbbdjftul.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFmZW51cmh0b3ZtbmJiZGpmdHVsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU0NzM4NTgsImV4cCI6MjA4MTA0OTg1OH0.r-uZD8flq8ASNCuPyZTDE440DUwK5IHjol34X2awDX4';
        
        // --- SECURITY: THE HASHED PIN ---
        // SHA-256 hash for "1234"
        const PIN_HASH = "03ac674216f3e15c761ee1a5e255f067953623c8b388b4459e13f978d7c846f4";

        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // --- LOGIN LOGIC (SECURE) ---
        async function checkLogin() {
            const inputPin = document.getElementById('adminPin').value;
            
            // 1. Hash the input
            const hash = await sha256(inputPin);

            // 2. Compare with stored hash
            if (hash === PIN_HASH) { 
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('dashboard').style.display = 'block';
                loadBookings();
            } else {
                alert("Wrong PIN");
            }
        }

        // --- HELPER: HASHING FUNCTION ---
        async function sha256(message) {
            const msgBuffer = new TextEncoder().encode(message);
            const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        }

        // --- LOAD BOOKINGS ---
        async function loadBookings() {
            const container = document.getElementById('bookings-list');
            container.innerHTML = 'Loading...';

            const { data, error } = await supabaseClient
                .from('bookings')
                .select('*')
                .order('booking_date', { ascending: true })
                .order('booking_time', { ascending: true });

            if (error) {
                container.innerHTML = 'Error loading bookings: ' + error.message;
                return;
            }

            container.innerHTML = '';
            
            if (data.length === 0) {
                container.innerHTML = '<p>No bookings found.</p>';
                return;
            }

            data.forEach(booking => {
                const div = document.createElement('div');
                div.className = 'booking-card';
                // Add Location to the display so they know which shop
                div.innerHTML = `
                    <div class="booking-info">
                        <strong style="color:#d4af37; font-size:1.2rem;">${booking.booking_time.slice(0,5)}</strong> 
                        <span style="color:#aaa;"> ${booking.booking_date}</span>
                        <span style="background:#333; padding:2px 6px; font-size:0.8rem; border-radius:4px; margin-left:10px;">${booking.location || 'Unknown'}</span>
                        <br>
                        <strong>${booking.barber_name}</strong> - ${booking.customer_name} (${booking.customer_phone})
                    </div>
                    <button class="cancel-btn" onclick="cancelBooking('${booking.id}')">Cancel</button>
                `;
                container.appendChild(div);
            });
        }

        // --- CANCEL BOOKING ---
        async function cancelBooking(id) {
            if (!confirm("Are you sure you want to cancel this booking?")) return;

            const { error } = await supabaseClient
                .from('bookings')
                .delete()
                .eq('id', id);

            if (error) {
                alert("Error: " + error.message);
            } else {
                alert("Booking Cancelled!");
                loadBookings(); 
            }
        }
    </script>
</body>
</html>